name: Auto Escalation System

on:
  schedule:
    # Executa a cada 5 minutos
    - cron: '*/5 * * * *'
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  auto-escalation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Execute Auto Escalation
      run: |
        echo "üîÑ Executando escala√ß√£o autom√°tica..."
        
        # Executar escala√ß√£o autom√°tica
        ESCALATION_RESPONSE=$(curl -s -X POST "https://www.ithostbr.tech/api/escalation/auto-execute" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Auto-Escalation/1.0")
        
        echo "üìä Resultado da escala√ß√£o: $ESCALATION_RESPONSE"
        
        # Processar e-mails de escala√ß√£o
        EMAIL_RESPONSE=$(curl -s -X POST "https://www.ithostbr.tech/api/escalation/process-emails" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Auto-Escalation/1.0")
        
        echo "üìß Resultado do processamento de e-mails: $EMAIL_RESPONSE"
        
        # Verificar se houve sucesso
        if echo "$ESCALATION_RESPONSE" | grep -q '"success":true'; then
          echo "‚úÖ Escala√ß√£o executada com sucesso"
        else
          echo "‚ùå Erro na execu√ß√£o da escala√ß√£o"
          exit 1
        fi
        
        if echo "$EMAIL_RESPONSE" | grep -q '"success":true'; then
          echo "‚úÖ E-mails processados com sucesso"
        else
          echo "‚ùå Erro no processamento de e-mails"
          exit 1
        fi

    - name: Log Execution
      run: |
        echo "üéØ Execu√ß√£o autom√°tica conclu√≠da em $(date)"
        echo "üìÖ Pr√≥xima execu√ß√£o em 5 minutos"
